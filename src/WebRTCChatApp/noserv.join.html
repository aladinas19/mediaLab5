<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8">
  <title>JOIN WebRTC channel</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>
<body>

<main class="container">
  <div class="card">
    <h2>JOIN WebRTC channel <span class="badge" id="status">init</span></h2>

    <h3>2) GET Creator's SDP</h3>
    <div class="row">
      <button id="start" type="button">Start</button>
    </div>
    <textarea id="creater-sdp" placeholder="HERE COPY AND PASTE [1.Creator'S SDP]"></textarea>

    <h3>3) CREATE Participant's SDP</h3>
    <textarea id="joiner-sdp"></textarea>

    <hr />

    <h3>VIDEO STREAM (Option A)</h3>
    <div class="note">Gautas kadras (per DataChannel)</div>
    <img id="remoteImage" alt="Remote frame will appear here" />
    <p class="note">
      Jei vaizdas neatsiranda – Create pusėje paspausk „Start camera“ ir „Start sending frames“.
    </p>

    <hr />

    <h3>CHAT</h3>
    <div id="chat">
      <div id="chat-screen-wp">
        <div id="chat-screen"></div>
      </div>
      <div class="row">
        <input id="msg" disabled placeholder="Žinutė..." />
        <button id="send" disabled type="button">send</button>
      </div>
    </div>
  </div>
</main>

<script>
var sdpConstraints = { optional: [{RtpDataChannels: true}]  };
var pc = new RTCPeerConnection(null);
var dc;

var remoteImage = document.getElementById("remoteImage");

pc.oniceconnectionstatechange = function() {
  var state = pc.iceConnectionState;
  $('#status').html(state);

  if (state == "connected") $("#msg, #send").attr("disabled", false);
};

pc.onicecandidate = function(e) {
  if (e.candidate) return;
  $("#joiner-sdp").val(JSON.stringify(pc.localDescription));
};

pc.ondatachannel = function(e) {
  dc = e.channel;

  dc.onopen = function() {
    $("textarea").attr("disabled", true);
    addMSG("CONNECTED!", "info");
  };

  dc.onmessage = function(e) {
    if (!e.data) return;

    if (typeof e.data === "string" && e.data.startsWith("FRAME|")) {
      var dataUrl = e.data.substring("FRAME|".length);
      remoteImage.src = dataUrl;
      return;
    }

    addMSG(e.data, "other");
  };
};

function start() {
  var offerSDP = $('#creater-sdp').val();
  var offerDesc = new RTCSessionDescription(JSON.parse(offerSDP));
  pc.setRemoteDescription(offerDesc);

  pc.createAnswer().then(function(e) {
    pc.setLocalDescription(e);
  });
}

var sendMSG = function() {
  var value = $("#msg").val();
  if (value && dc && dc.readyState === "open") {
    dc.send(value);
    addMSG(value, "me");
    $("#msg").val('');
  }
};

var addMSG = function(msg, who) {
  var wrap = $("<div>").addClass("wrap").appendTo($("#chat-screen"));
  var div  = $("<div>").addClass(who).appendTo(wrap);
  $("<span>").html(who).addClass("who").appendTo(div);
  $("<span>").html(msg).addClass("msg").appendTo(div);
  $("#chat-screen-wp").scrollTop($("#chat-screen").height());
};

$("#start").click(function(){ start(); });
$("#msg").keypress(function(e) { if(e.which == 13) { sendMSG(); } });
$("#send").click(sendMSG);
</script>

</body>
</html>
